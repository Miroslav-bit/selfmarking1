<!DOCTYPE html>
<html lang="sr">
<head>
  <meta charset="UTF-8">
  <title>Korisnički panel - Selfmarking</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <header>
      <div class="user-info">
        <img id="userAvatar" class="avatar" src="" alt="Avatar">
        <span id="userIme"></span>
        <button onclick="logout()">Odjavi se</button>
      </div>
      <h1>Selfmarking.com</h1>
      <p>Vi ocenjujete druge i drugi ocenjuju Vas!</p>
      <h2>Tema: Snaga</h2>
    </header>

    <section class="form-section">
      <textarea id="postText" placeholder="Unesi svoju objavu o snazi..."></textarea>
      <button onclick="addPost()">Dodaj objavu</button>
    </section>

    <section class="posts-section">
      <h3>Objave</h3>
      <div id="postsContainer"></div>
    </section>
  </div>

  <script>
    window.onload = function () {
      const ime = localStorage.getItem("userIme");
      const avatar = localStorage.getItem("userAvatar");
      const token = localStorage.getItem("token");

      if (!token) {
        alert("Morate biti prijavljeni.");
        window.location.href = "login.html";
        return;
      }

      document.getElementById("userIme").innerText = ime;
      document.getElementById("userAvatar").src = avatar || "default-avatar.png";
      loadPosts();
    };

    async function addPost() {
      const token = localStorage.getItem("token");
      const textArea = document.getElementById("postText");
      const text = textArea.value.trim();

      if (!text) {
        alert("Unesi neki tekst.");
        return;
      }

      try {
        const res = await fetch("https://selfmarking-backend.onrender.com/api/posts", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token
          },
          body: JSON.stringify({ text })
        });

        if (res.ok) {
          textArea.value = "";
          loadPosts();
        } else {
          const data = await res.json();
          alert(data.msg || "Greška pri objavljivanju.");
        }
      } catch (err) {
        console.error("Greška:", err);
        alert("Greška pri slanju objave.");
      }
    }

    async function loadPosts() {
      try {
        const res = await fetch("https://selfmarking-backend.onrender.com/api/posts");
        const posts = await res.json();

        const container = document.getElementById("postsContainer");
        container.innerHTML = "";

        posts.forEach(post => {
          const div = document.createElement("div");
          div.className = "post";

          const autor = document.createElement("div");
          autor.className = "post-autor";
          autor.innerHTML = `
            <img src="${post.user?.avatar || 'default-avatar.png'}" class="avatar-small">
            <strong>${post.user?.ime || 'Nepoznat'}</strong>
          `;

          const datum = document.createElement("div");
          datum.className = "post-date";
          datum.innerText = new Date(post.date).toLocaleString("sr-RS");

          const tekst = document.createElement("div");
          tekst.innerText = post.text;

          div.appendChild(autor);
          div.appendChild(datum);
          div.appendChild(tekst);

          container.appendChild(div);
        });
      } catch (err) {
        console.error("Greška:", err);
        alert("Greška pri učitavanju objava.");
      }
    }

    function logout() {
      localStorage.clear();
      window.location.href = "login.html";
    }
  </script>

  <style>
    .user-info {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .avatar {
      height: 40px;
      border-radius: 50%;
    }
    .avatar-small {
      height: 30px;
      width: 30px;
      border-radius: 50%;
      margin-right: 10px;
    }
    .post-autor {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 5px;
    }
  </style>
</body>
</html>
