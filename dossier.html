<!DOCTYPE html>

<html lang="sr">
<head>
<meta charset="utf-8"/>
<title>Dosije ocenjenog člana</title>
<link href="style.css" rel="stylesheet"/>
<style>
    .breadcrumb {
      font-size: 14px;
      margin-bottom: 20px;
      color: #555;
    }
    .breadcrumb a {
      color: #007bff;
      text-decoration: none;
    }
    .breadcrumb a:hover {
      text-decoration: underline;
    }
    .main-title {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 10px;
    }
    .sub-title {
      font-size: 18px;
      margin-top: 30px;
      font-weight: bold;
      border-bottom: 1px solid #ccc;
      padding-bottom: 5px;
    }
    .ocenjivanje-tabela {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    .ocenjivanje-tabela th,
    .ocenjivanje-tabela td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: left;
    }
    .ocenjivanje-tabela th {
      background-color: #f0f0f0;
    }
  </style>
</head>
<body>
<div class="container">
<div class="breadcrumb">
<a href="index.html">Home</a> &gt;
      <a href="my-log.html">Moj dnevnik ocenjivanja</a> &gt;
      Ocenjeni član
    </div>
<div class="main-title">Ocenjeni član: <span id="ime-prezime">Učitavanje...</span></div>
<table class="ocenjivanje-tabela">
<thead>
<tr>
<th>Kategorije:</th>
<th>Moje ocene:</th>
<th>Parametri:</th>
</tr>
</thead>
<tbody id="tabela-ocene">
<!-- Dinamika dolazi u sledećim fazama -->
</tbody>
</table>
</div>
<script>
const BASE_URL = "https://selfmarking-backend.onrender.com";
const params = new URLSearchParams(window.location.search);
const ime = params.get("name") || "";
const prezime = params.get("surname") || "";
const ratedName = (ime + " " + prezime).trim();
document.getElementById("ime-prezime").innerText = ratedName;

// Standardizovani nazivi glavnih kategorija
const standardMainCategories = {
  "obrazovanje": "Obrazovanje",
  "inteligencija": "Inteligencija",
  "karakterne osobine": "Karakterne osobine"
};

// Mapiranje potkategorija na glavne kategorije
const subToMainCategory = {
  "matematika": "Obrazovanje",
  "fizika": "Obrazovanje",
  "hemija": "Obrazovanje",
  "astronomija": "Obrazovanje",
  "geologija": "Obrazovanje",
  "logika": "Inteligencija",
  "komunikativnost": "Inteligencija",
  "duhovitost": "Inteligencija",
  "hrabrost": "karakterne osobine",
  "samouverenost": "karakterne osobine",
  "smirenost": "karakterne osobine",
  "empatija": "karakterne osobine",
};

const token = localStorage.getItem("token");
if (!token) {
  alert("Niste prijavljeni.");
  window.location.href = "login.html";
} else {
  fetch(BASE_URL + "/api/user/me", {
    headers: { "Authorization": "Bearer " + token }
  })
  .then(res => res.json())
  .then(user => {
    const loggedUser = (user.name + " " + user.surname).trim();
    localStorage.setItem("userFullName", loggedUser);
    ucitajOcene(loggedUser, ratedName);
  })
  .catch(err => {
    console.error("Greška pri autentikaciji:", err);
    alert("Greška pri učitavanju korisnika.");
  });
}

function ucitajOcene(loggedUser, ratedName) {
  fetch(BASE_URL + "/api/ratings/dossier?raterName=" + encodeURIComponent(loggedUser) + "&ratedName=" + encodeURIComponent(ratedName))
    .then(res => {
      if (!res.ok) throw new Error("Greška u zahtevu: " + res.status);
      return res.json();
    })
    .then(data => {
      const tabela = document.getElementById("tabela-ocene");
      if (!data || data.length === 0) {
        tabela.innerHTML = '<tr><td colspan="3">Nema podataka za prikaz.</td></tr>';
        return;
      }

      const grouped = {};

      data.forEach(entry => {
        const sub = entry.cardSub || "-";
        const subKey = sub.toLowerCase();

        const potentialMainKey = subKey;
        const standardizedMain = standardMainCategories[potentialMainKey];

        // Ako je glavna kategorija (npr. "FiziČka Snaga" iz baze)
        if (standardizedMain) {
          if (!grouped[standardizedMain]) grouped[standardizedMain] = { glavno: null, pods: [] };
          grouped[standardizedMain].glavno = entry;
        } else {
          const subMapped = subToMainCategory[subKey];
          const stdMain = subMapped ? standardMainCategories[subMapped.toLowerCase()] : "Nepoznata kategorija";
          if (!grouped[stdMain]) grouped[stdMain] = { glavno: null, pods: [] };
          grouped[stdMain].pods.push(entry);
        }
      });

      // Dodaj statičnu rubriku "Ukupna ocena" na vrh tabele
      // Priprema sabiranja svih q vrednosti
      let ukupnoQ = 0;
      let brojQ = 0;

      const ukupnaOcenaRow = document.createElement("tr");

      const ukupnaCell = document.createElement("td");
      ukupnaCell.textContent = "Ukupna ocena";
      ukupnaCell.style.fontWeight = "bold";
      ukupnaCell.colSpan = 1;

      const praznaCell1 = document.createElement("td");
      const parametarCell = document.createElement("td");

      // Unosi se odmah, vrednost p će se dopuniti kasnije
      ukupnaOcenaRow.appendChild(ukupnaCell);
      ukupnaOcenaRow.appendChild(praznaCell1);
      ukupnaOcenaRow.appendChild(parametarCell);

      tabela.appendChild(ukupnaOcenaRow);

      Object.entries(grouped).forEach(([main, { glavno, pods }]) => {
        const mainRow = document.createElement("tr");

        const mainCell = document.createElement("td");
        mainCell.textContent = main;
        mainCell.style.fontWeight = "bold";
        mainCell.style.fontSize = "16px";

        const scoreCell = document.createElement("td");
        const paramCell = document.createElement("td");

        const v = pods.filter(e => typeof e.score === 'number').length;
        const y = Object.entries(subToMainCategory).filter(([_, cat]) => cat.toLowerCase() === main.toLowerCase()).length;
        const w = y - v;
        const a = pods.reduce((acc, e) => acc + (typeof e.score === 'number' ? e.score : 0), 0);
        const b = w * 5;
        const x = a + b;
        const z = y > 0 ? x / y : "-";

        scoreCell.textContent = glavno ? (glavno.score ?? "-") : "";
        let q;
        if (glavno && typeof glavno.score === "number") {
          q = glavno.score;
        } else {
          q = z;
        }

        // Zaokruži q na 2 decimale ako je broj
        const qFormatted = (typeof q === "number") ? Number(q).toFixed(2).replace(/\.?0+$/, '') : "-";

        paramCell.innerHTML = `a = ${a} ; b = ${b} ; x = ${x} ; v = ${v} ; w = ${w} ; y = ${y} ; z = ${z} ; <span style="color:red">q = ${qFormatted}</span>`;
        if (typeof q === "number") {
          ukupnoQ += q;
          brojQ += 1;
        }

        mainRow.appendChild(mainCell);
        mainRow.appendChild(scoreCell);
        mainRow.appendChild(paramCell);
        tabela.appendChild(mainRow);

        pods.forEach(e => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${e.cardSub || "-"}</td>
            <td>${e.score ?? "-"}</td>
            <td>${e.timestamp ? new Date(e.timestamp).toLocaleString() : "-"}</td>
          `;
          tabela.appendChild(row);
        });
      });
      const p = ukupnoQ.toFixed(2).replace(/\.?0+$/, '');
      const r = Object.keys(grouped).length;
      parametarCell.innerHTML = `p = ${p} ; r = ${r} ;`;
    })
    .catch(err => {
      console.error("Greška:", err);
      document.getElementById("tabela-ocene").innerHTML = '<tr><td colspan="3">Greška pri učitavanju podataka.</td></tr>';
    });
}
</script>
</body>
</html>
